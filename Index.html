<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
      :root {
        --primary: #1a73e8;
        --bg: #f1f3f4;
        --card: #ffffff;
        --broken: #d93025;
        --good: #1e8e3e;
      }

      body {
        font-family: 'Roboto', sans-serif;
        background-color: var(--bg);
        margin: 0;
        padding: 20px;
      }

      /* ── TEACHER MANAGEMENT PANEL ── */
      .mgmt-panel {
        background: var(--card);
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.12);
        margin-bottom: 24px;
        overflow: hidden;
      }

      .mgmt-panel-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 14px 18px;
        cursor: pointer;
        user-select: none;
        border-bottom: 1px solid #eee;
        font-weight: 500;
        font-size: 1em;
        color: #333;
      }

      .mgmt-panel-header:hover { color: var(--primary); }

      .mgmt-panel-header .collapse-icon {
        font-size: 0.75em;
        color: #aaa;
        transition: transform 0.25s ease;
      }

      .mgmt-panel.collapsed .mgmt-panel-header .collapse-icon {
        transform: rotate(-90deg);
      }

      .mgmt-panel.collapsed .mgmt-panel-header {
        border-bottom-color: transparent;
      }

      .mgmt-panel-body {
        overflow: hidden;
        max-height: 800px;
        opacity: 1;
        transition: max-height 0.3s ease, opacity 0.25s ease;
        padding: 18px;
      }

      .mgmt-panel.collapsed .mgmt-panel-body {
        max-height: 0;
        opacity: 0;
        padding-top: 0;
        padding-bottom: 0;
      }

      .mgmt-form {
        display: flex;
        gap: 10px;
        align-items: flex-end;
        flex-wrap: wrap;
        margin-bottom: 16px;
      }

      .mgmt-form-field {
        display: flex;
        flex-direction: column;
        gap: 4px;
        flex: 1;
        min-width: 140px;
      }

      .mgmt-form-field label {
        font-size: 0.85em;
        color: #555;
        font-weight: 500;
        margin: 0;
      }

      .mgmt-form-field input {
        padding: 9px 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-family: inherit;
        font-size: 0.9em;
        box-sizing: border-box;
        width: 100%;
        margin: 0;
      }

      .btn-add-teacher {
        background: var(--primary);
        color: white;
        padding: 9px 18px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 500;
        font-family: inherit;
        font-size: 0.9em;
        white-space: nowrap;
        align-self: flex-end;
      }

      .btn-add-teacher:disabled { opacity: 0.6; cursor: not-allowed; }

      .mgmt-msg {
        font-size: 0.85em;
        padding: 6px 0;
        min-height: 1.2em;
      }

      .mgmt-msg.success { color: var(--good); }
      .mgmt-msg.error   { color: var(--broken); }

      /* Teacher list table */
      .teacher-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9em;
      }

      .teacher-table th {
        text-align: left;
        padding: 8px 10px;
        border-bottom: 2px solid #eee;
        color: #555;
        font-weight: 500;
      }

      .teacher-table td {
        padding: 8px 10px;
        border-bottom: 1px solid #f0f0f0;
        color: #333;
        vertical-align: middle;
      }

      .teacher-table tr:last-child td { border-bottom: none; }

      .teacher-table tbody tr:hover { background: #f8f9fa; }

      .btn-edit-teacher {
        background: none;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 4px 10px;
        font-size: 0.8em;
        cursor: pointer;
        color: var(--primary);
        font-family: inherit;
      }

      .btn-edit-teacher:hover { background: #e8f0fe; }

      .no-teachers-msg {
        color: #999;
        font-size: 0.9em;
        text-align: center;
        padding: 12px 0;
      }

      /* ── MAIN GRID SYSTEM ── */
      .app-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
      }

      /* TEACHER CARD */
      .teacher-card {
        background: var(--card);
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.12);
        padding: 15px;
      }

      /* TEACHER HEADER - clickable to collapse */
      .teacher-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        border-bottom: 1px solid #eee;
        margin-bottom: 10px;
        padding-bottom: 8px;
        cursor: pointer;
        user-select: none;
      }

      .teacher-header:hover .teacher-name { color: var(--primary); }

      .teacher-info { flex: 1; }

      .teacher-name {
        font-weight: 500;
        font-size: 1.1em;
        color: #333;
        transition: color 0.15s;
      }

      .teacher-room {
        font-size: 0.8em;
        color: #888;
        margin-top: 2px;
      }

      .collapse-icon {
        font-size: 0.75em;
        color: #aaa;
        transition: transform 0.25s ease;
        flex-shrink: 0;
        margin-left: 8px;
        margin-top: 4px;
      }

      /* Collapsed state */
      .teacher-card.collapsed .collapse-icon {
        transform: rotate(-90deg);
      }

      .teacher-card.collapsed .teacher-header {
        border-bottom-color: transparent;
        margin-bottom: 0;
        padding-bottom: 0;
      }

      /* SLOT GRID inside Teacher Card */
      .slot-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
        gap: 8px;
        overflow: hidden;
        max-height: 2000px;
        opacity: 1;
        transition: max-height 0.3s ease, opacity 0.25s ease;
      }

      .teacher-card.collapsed .slot-grid {
        max-height: 0;
        opacity: 0;
      }

      /* INDIVIDUAL DEVICE */
      .device-chip {
        background: #e8f0fe;
        color: var(--primary);
        padding: 8px 4px;
        border-radius: 4px;
        text-align: center;
        cursor: pointer;
        font-size: 0.85em;
        user-select: none;
        transition: transform 0.1s;
      }

      .device-chip:active { transform: scale(0.95); }

      .device-chip.broken {
        background: #fce8e6;
        color: var(--broken);
        border: 1px solid var(--broken);
      }

      .device-chip .slot-num {
        display: block;
        font-weight: bold;
        font-size: 0.8em;
        opacity: 0.7;
      }

      /* ── DEVICE MODAL ── */
      .modal-overlay {
        display: none;
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 100;
        justify-content: center;
        align-items: center;
      }

      .modal {
        background: white;
        padding: 25px;
        border-radius: 8px;
        width: 90%;
        max-width: 440px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 4px 12px rgba(0,0,0,0.25);
      }

      .modal h2 { margin-top: 0; }

      /* FORMS */
      label {
        display: block;
        margin-top: 15px;
        font-size: 0.9em;
        color: #555;
        font-weight: 500;
      }

      select, input[type="text"] {
        width: 100%;
        padding: 10px;
        margin-top: 5px;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-sizing: border-box;
        font-family: inherit;
        font-size: 0.9em;
      }

      /* REPLACEMENT POOL CONTROLS */
      .pool-toolbar {
        display: flex;
        gap: 8px;
        margin-top: 8px;
        align-items: center;
      }

      .pool-search-input {
        flex: 1;
        padding: 8px 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 0.9em;
        font-family: inherit;
        box-sizing: border-box;
      }

      .pool-sort-select {
        padding: 8px 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 0.85em;
        background: #f8f9fa;
        cursor: pointer;
        font-family: inherit;
        flex-shrink: 0;
      }

      .pool-count {
        font-size: 0.78em;
        color: #999;
        margin-top: 4px;
        text-align: right;
      }

      #replacementSelect {
        height: 160px;
        margin-top: 6px;
      }

      .btn-group {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 25px;
      }

      button {
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 500;
        font-family: inherit;
      }

      .btn-cancel { background: #eee; color: #333; }
      .btn-save   { background: var(--primary); color: white; }

      /* LOADING */
      #loader { text-align: center; margin-top: 50px; color: #666; }
    </style>
  </head>
  <body>

    <!-- ── TEACHER MANAGEMENT PANEL ── -->
    <div id="mgmtPanel" class="mgmt-panel collapsed">
      <div class="mgmt-panel-header" onclick="toggleMgmtPanel()">
        <span>Teacher Management</span>
        <span class="collapse-icon">&#9660;</span>
      </div>
      <div class="mgmt-panel-body">

        <!-- Add / Edit form -->
        <div class="mgmt-form">
          <div class="mgmt-form-field">
            <label for="inputTeacherName">Teacher Name</label>
            <input type="text" id="inputTeacherName" placeholder="e.g. Smith" autocomplete="off">
          </div>
          <div class="mgmt-form-field">
            <label for="inputRoomNumber">Room Number</label>
            <input type="text" id="inputRoomNumber" placeholder="e.g. 204" autocomplete="off">
          </div>
          <button class="btn-add-teacher" id="btnSaveTeacher" onclick="saveTeacherEntry()">Save Teacher</button>
        </div>
        <div class="mgmt-msg" id="mgmtMsg"></div>

        <!-- Existing teachers table -->
        <div id="teacherTableWrap"></div>
      </div>
    </div>

    <div id="loader">Loading Inventory...</div>
    <div id="app" class="app-container" style="display:none;"></div>

    <!-- ── DEVICE EDIT MODAL ── -->
    <div id="modalOverlay" class="modal-overlay">
      <div class="modal">
        <h2 id="modalTitle">Device Details</h2>
        <div id="modalDetails" style="margin-bottom:15px; font-size:0.9em; color:#666;"></div>

        <form id="updateForm">
          <input type="hidden" id="rowIndex" name="rowIndex">

          <label>Status</label>
          <select id="statusSelect" name="status" onchange="toggleReplacement()">
            <option value="Working">Working</option>
            <option value="Broken">Broken / Needs Repair</option>
          </select>

          <div id="replacementContainer" style="display:none;">
            <label>Assign Replacement (From Pool)</label>

            <div class="pool-toolbar">
              <input
                type="text"
                class="pool-search-input"
                id="poolSearch"
                placeholder="Search serial or model..."
                oninput="filterPool()"
                autocomplete="off"
              >
              <select class="pool-sort-select" id="poolSort" onchange="filterPool()">
                <option value="serial-asc">Serial A-Z</option>
                <option value="serial-desc">Serial Z-A</option>
                <option value="model-asc">Model A-Z</option>
                <option value="model-desc">Model Z-A</option>
              </select>
            </div>

            <div class="pool-count" id="poolCount"></div>

            <select id="replacementSelect" name="replacementSerial">
              <option value="">-- Select Available Device --</option>
            </select>
          </div>

          <div class="btn-group">
            <button type="button" class="btn-cancel" onclick="closeModal()">Cancel</button>
            <button type="button" class="btn-save" onclick="saveUpdate()">Save Update</button>
          </div>
        </form>
      </div>
    </div>

    <script>
      var globalData      = {};
      var globalPool      = []; // Array of { serial, model }
      var globalTeachers  = {}; // { "TeacherName": "RoomNumber" }

      // ── INITIAL LOAD ──
      window.onload = function() {
        google.script.run.withSuccessHandler(renderApp).getAppData();
      };

      // ── RENDER EVERYTHING ──
      function renderApp(data) {
        globalData     = data.inventory;
        globalPool     = data.replacements;
        globalTeachers = data.teacherRooms || {};

        renderTeacherTable();
        renderCards();
      }

      // ── TEACHER MANAGEMENT PANEL ──
      function toggleMgmtPanel() {
        document.getElementById('mgmtPanel').classList.toggle('collapsed');
      }

      function renderTeacherTable() {
        var wrap = document.getElementById('teacherTableWrap');
        var keys = Object.keys(globalTeachers).sort();

        if (keys.length === 0) {
          wrap.innerHTML = '<p class="no-teachers-msg">No teachers added yet. Use the form above to add one.</p>';
          return;
        }

        var html = '<table class="teacher-table"><thead><tr>' +
          '<th>Teacher Name</th><th>Room</th><th></th>' +
          '</tr></thead><tbody>';

        keys.forEach(function(name) {
          var room = globalTeachers[name] || '—';
          html += '<tr>' +
            '<td>' + escHtml(name) + '</td>' +
            '<td>' + escHtml(room) + '</td>' +
            '<td><button class="btn-edit-teacher" onclick="prefillTeacher(' +
              JSON.stringify(name) + ',' + JSON.stringify(globalTeachers[name] || '') +
            ')">Edit</button></td>' +
            '</tr>';
        });

        html += '</tbody></table>';
        wrap.innerHTML = html;
      }

      function prefillTeacher(name, room) {
        document.getElementById('inputTeacherName').value = name;
        document.getElementById('inputRoomNumber').value  = room;
        document.getElementById('inputTeacherName').focus();
        setMgmtMsg('', '');
      }

      function saveTeacherEntry() {
        var name = document.getElementById('inputTeacherName').value.trim();
        var room = document.getElementById('inputRoomNumber').value.trim();

        if (!name) {
          setMgmtMsg('Teacher name is required.', 'error');
          return;
        }

        var btn = document.getElementById('btnSaveTeacher');
        btn.disabled = true;
        btn.innerText = 'Saving...';
        setMgmtMsg('', '');

        google.script.run
          .withSuccessHandler(function(result) {
            btn.disabled = false;
            btn.innerText = 'Save Teacher';

            if (result.status === 'error') {
              setMgmtMsg(result.message, 'error');
              return;
            }

            // Update local cache and re-render
            globalTeachers[result.teacher] = result.room;
            renderTeacherTable();
            renderCards(); // refresh room badges on cards

            document.getElementById('inputTeacherName').value = '';
            document.getElementById('inputRoomNumber').value  = '';

            var action = result.status === 'added' ? 'Added' : 'Updated';
            setMgmtMsg(action + ': ' + result.teacher + (result.room ? ' — Room ' + result.room : ''), 'success');
          })
          .withFailureHandler(function(err) {
            btn.disabled = false;
            btn.innerText = 'Save Teacher';
            setMgmtMsg('Error: ' + err.message, 'error');
          })
          .saveTeacher({ teacherName: name, roomNumber: room });
      }

      function setMgmtMsg(text, type) {
        var el = document.getElementById('mgmtMsg');
        el.innerText = text;
        el.className = 'mgmt-msg' + (type ? ' ' + type : '');
      }

      // ── RENDER TEACHER CARDS ──
      function renderCards() {
        var app = document.getElementById('app');
        app.innerHTML = '';

        var teachers = Object.keys(globalData).sort();

        teachers.forEach(function(teacher) {
          var card = document.createElement('div');
          card.className = 'teacher-card';

          // --- Collapsible Header ---
          var header = document.createElement('div');
          header.className = 'teacher-header';

          var info = document.createElement('div');
          info.className = 'teacher-info';

          var nameEl = document.createElement('div');
          nameEl.className = 'teacher-name';
          nameEl.innerText = teacher;
          info.appendChild(nameEl);

          var room = globalTeachers[teacher];
          if (room) {
            var roomEl = document.createElement('div');
            roomEl.className = 'teacher-room';
            roomEl.innerText = 'Room ' + room;
            info.appendChild(roomEl);
          }

          var icon = document.createElement('span');
          icon.className = 'collapse-icon';
          icon.innerHTML = '&#9660;'; // ▼

          header.appendChild(info);
          header.appendChild(icon);
          header.onclick = function() { card.classList.toggle('collapsed'); };

          card.appendChild(header);

          // --- Slot Grid ---
          var grid = document.createElement('div');
          grid.className = 'slot-grid';

          var devices = globalData[teacher].sort(function(a, b) {
            return parseInt(a.slot.replace('Slot ', '')) - parseInt(b.slot.replace('Slot ', ''));
          });

          devices.forEach(function(device) {
            var chip = document.createElement('div');
            chip.className = 'device-chip' + (device.status === 'Broken' ? ' broken' : '');
            chip.innerHTML = '<span class="slot-num">' + device.slot + '</span>' + device.serial.substring(0, 6) + '...';
            chip.onclick = function() { openModal(device); };
            grid.appendChild(chip);
          });

          card.appendChild(grid);
          app.appendChild(card);
        });

        document.getElementById('loader').style.display = 'none';
        app.style.display = 'grid';
      }

      // ── DEVICE MODAL ──
      function openModal(device) {
        document.getElementById('modalTitle').innerText = device.teacher + ' - ' + device.slot;
        document.getElementById('modalDetails').innerHTML =
          'Model: ' + device.model + '<br>Serial: <b>' + device.serial + '</b><br>Current Status: ' + device.status;

        document.getElementById('rowIndex').value = device.rowIndex;
        document.getElementById('statusSelect').value = device.status || 'Working';

        // Reset pool controls
        document.getElementById('poolSearch').value = '';
        document.getElementById('poolSort').value = 'serial-asc';

        filterPool();
        toggleReplacement();
        document.getElementById('modalOverlay').style.display = 'flex';
      }

      function filterPool() {
        var query  = document.getElementById('poolSearch').value.toLowerCase().trim();
        var sortBy = document.getElementById('poolSort').value;

        var filtered = globalPool.filter(function(item) {
          if (!query) return true;
          return item.serial.toLowerCase().indexOf(query) !== -1 ||
                 item.model.toLowerCase().indexOf(query) !== -1;
        });

        filtered.sort(function(a, b) {
          switch (sortBy) {
            case 'serial-asc':  return a.serial.localeCompare(b.serial);
            case 'serial-desc': return b.serial.localeCompare(a.serial);
            case 'model-asc':   return a.model.localeCompare(b.model);
            case 'model-desc':  return b.model.localeCompare(a.model);
            default:            return 0;
          }
        });

        var repSelect = document.getElementById('replacementSelect');
        var prevValue = repSelect.value;

        repSelect.innerHTML = '<option value="">-- Select Available Device --</option>';
        filtered.forEach(function(item) {
          var opt = document.createElement('option');
          opt.value    = item.serial;
          opt.innerText = item.serial + '  (' + item.model + ')';
          repSelect.appendChild(opt);
        });

        if (prevValue && filtered.some(function(item) { return item.serial === prevValue; })) {
          repSelect.value = prevValue;
        }

        var total = globalPool.length;
        var shown = filtered.length;
        document.getElementById('poolCount').innerText =
          shown === total
            ? total + ' device' + (total !== 1 ? 's' : '') + ' available'
            : shown + ' of ' + total + ' device' + (total !== 1 ? 's' : '') + ' shown';
      }

      function toggleReplacement() {
        var status    = document.getElementById('statusSelect').value;
        var container = document.getElementById('replacementContainer');
        if (status === 'Broken') {
          container.style.display = 'block';
        } else {
          container.style.display = 'none';
          document.getElementById('replacementSelect').value = '';
        }
      }

      function closeModal() {
        document.getElementById('modalOverlay').style.display = 'none';
      }

      function saveUpdate() {
        var btn = document.querySelector('.btn-save');
        btn.innerText = 'Saving...';
        btn.disabled  = true;

        var form = document.getElementById('updateForm');

        google.script.run.withSuccessHandler(function() {
          closeModal();
          btn.innerText = 'Save Update';
          btn.disabled  = false;
          document.getElementById('loader').style.display = 'block';
          document.getElementById('app').style.display    = 'none';
          google.script.run.withSuccessHandler(renderApp).getAppData();
        }).submitUpdate(form);
      }

      // ── UTILITY ──
      function escHtml(str) {
        return String(str)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;');
      }
    </script>
  </body>
</html>
