<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: '#1a73e8',
              'primary-light': '#e8f0fe',
              'primary-hover': '#d2e3fc',
              broken: '#d93025',
              'broken-light': '#fce8e6',
              good: '#1e8e3e',
              surface: '#f1f3f4',
              card: '#ffffff',
            },
            fontFamily: {
              sans: ['Roboto', 'sans-serif'],
              mono: ['Roboto Mono', 'monospace'],
            },
          },
        },
      }
    </script>
    <style type="text/tailwindcss">
      .collapse-animate {
        transition: max-height 0.3s ease, opacity 0.25s ease, padding 0.3s ease;
      }
      @keyframes spin { to { transform: rotate(360deg); } }
      .spinner {
        width: 18px; height: 18px;
        border: 2px solid #e5e7eb;
        border-top-color: #1a73e8;
        border-radius: 50%;
        animation: spin 0.6s linear infinite;
        display: inline-block;
        vertical-align: middle;
        margin-right: 6px;
      }
      /* Mobile scrolling optimizations */
      .scroll-touch {
        -webkit-overflow-scrolling: touch;
        overscroll-behavior: contain;
      }
      body {
        touch-action: manipulation;
      }
      #app {
        touch-action: pan-y;
      }
      .teacher-card {
        content-visibility: auto;
        contain-intrinsic-size: 0 200px;
      }
    </style>
  </head>
  <body class="bg-surface font-sans m-0 p-3 sm:p-5">

    <!-- TOAST NOTIFICATION CONTAINER -->
    <div id="toastContainer" class="fixed top-4 left-4 right-4 sm:left-auto sm:right-4 z-[200] flex flex-col gap-2 pointer-events-none sm:max-w-[380px]"></div>

    <!-- TEACHER MANAGEMENT PANEL -->
    <div id="mgmtPanel" class="bg-card rounded-lg shadow-sm mb-6 overflow-hidden">
      <div
        class="flex justify-between items-center px-3 sm:px-[18px] py-4 sm:py-3.5 cursor-pointer select-none border-b border-gray-200 font-medium text-gray-700 hover:text-primary transition-colors"
        onclick="toggleMgmtPanel()"
        id="mgmtPanelHeader"
      >
        <span>Teacher Management</span>
        <span class="text-xs text-gray-400 transition-transform duration-300" id="mgmtCollapseIcon">&#9660;</span>
      </div>
      <div class="collapse-animate overflow-hidden max-h-0 opacity-0 px-3 sm:px-[18px] py-0" id="mgmtPanelBody">

        <!-- Add / Edit form -->
        <div class="flex gap-2.5 items-end flex-wrap mb-4 pt-3 sm:pt-[18px]">
          <div class="flex flex-col gap-1 w-full sm:flex-1 sm:min-w-[140px]">
            <label for="inputTeacherName" class="text-sm text-gray-500 font-medium !block !mt-0">Teacher Name</label>
            <input type="text" id="inputTeacherName" placeholder="e.g. Smith" autocomplete="off"
              class="px-2.5 py-2.5 sm:py-2 border border-gray-300 rounded font-sans text-sm w-full box-border">
          </div>
          <div class="flex flex-col gap-1 w-full sm:flex-1 sm:min-w-[140px]">
            <label for="inputRoomNumber" class="text-sm text-gray-500 font-medium !block !mt-0">Room Number</label>
            <input type="text" id="inputRoomNumber" placeholder="e.g. 204" autocomplete="off"
              class="px-2.5 py-2.5 sm:py-2 border border-gray-300 rounded font-sans text-sm w-full box-border">
          </div>
          <button class="bg-primary text-white px-[18px] py-2.5 sm:py-2 border-none rounded cursor-pointer font-medium font-sans text-sm whitespace-nowrap w-full sm:w-auto sm:self-end hover:bg-blue-700 hover:shadow-md hover:-translate-y-0.5 active:translate-y-0 disabled:opacity-60 disabled:cursor-not-allowed disabled:hover:translate-y-0 disabled:hover:shadow-none transition-all duration-200"
            id="btnSaveTeacher" onclick="saveTeacherEntry()">Save Teacher</button>
        </div>
        <div class="text-sm py-1.5 min-h-[1.2em]" id="mgmtMsg"></div>

        <!-- Existing teachers table -->
        <div id="teacherTableWrap" class="pb-[18px]"></div>
      </div>
    </div>

    <!-- AUDIT LOG PANEL -->
    <div id="auditPanel" class="bg-card rounded-lg shadow-sm mb-6 overflow-hidden">
      <div
        class="flex justify-between items-center px-3 sm:px-[18px] py-4 sm:py-3.5 cursor-pointer select-none font-medium text-gray-700 hover:text-primary transition-colors"
        onclick="toggleAuditPanel()"
        id="auditPanelHeader"
      >
        <span>Audit Log</span>
        <span class="text-xs text-gray-400 transition-transform duration-300" id="auditCollapseIcon" style="transform:rotate(-90deg);">&#9660;</span>
      </div>
      <div class="collapse-animate overflow-hidden max-h-0 opacity-0 px-3 sm:px-[18px] py-0" id="auditPanelBody">
        <div class="pt-3 sm:pt-[18px] pb-[18px]">
          <div class="flex justify-between items-center mb-3">
            <span class="text-sm text-gray-400" id="auditCount"></span>
            <button
              class="bg-gray-50 border border-gray-300 rounded-md px-3.5 py-2.5 sm:py-2 text-sm cursor-pointer font-sans font-medium text-gray-500 whitespace-nowrap transition-all duration-200 hover:bg-primary-light hover:text-primary hover:border-primary hover:shadow-sm hover:-translate-y-px active:translate-y-0"
              onclick="loadAuditLog()"
              id="btnRefreshAudit"
            >Refresh</button>
          </div>
          <div id="auditLogWrap" class="text-sm text-gray-400 text-center py-3">Open this panel to load audit entries.</div>
        </div>
      </div>
    </div>

    <!-- SEARCH & TOOLBAR -->
    <div class="bg-card rounded-lg shadow-sm mb-5 px-3 sm:px-[18px] py-3 sm:py-3.5 flex items-center gap-2 sm:gap-3 flex-wrap" id="toolbar" style="display:none;">
      <div class="w-full sm:flex-1 sm:min-w-[200px] relative">
        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm pointer-events-none">&#128269;</span>
        <input type="text" id="teacherSearch" placeholder="Search for a teacher..." oninput="onTeacherSearch()" autocomplete="off"
          class="w-full py-2.5 pl-9 pr-3.5 border border-gray-300 rounded-md font-sans text-[0.95em] box-border bg-gray-50 transition-all focus:outline-none focus:border-primary focus:bg-white">
      </div>
      <div class="flex gap-2 flex-shrink-0 w-full sm:w-auto">
        <button class="bg-gray-50 border border-gray-300 rounded-md px-3.5 py-2.5 sm:py-2 text-sm cursor-pointer font-sans font-medium text-gray-500 whitespace-nowrap transition-all duration-200 hover:bg-primary-light hover:text-primary hover:border-primary hover:shadow-sm hover:-translate-y-px active:translate-y-0 flex-1 sm:flex-none"
          onclick="expandAll()">Expand All</button>
        <button class="bg-gray-50 border border-gray-300 rounded-md px-3.5 py-2.5 sm:py-2 text-sm cursor-pointer font-sans font-medium text-gray-500 whitespace-nowrap transition-all duration-200 hover:bg-primary-light hover:text-primary hover:border-primary hover:shadow-sm hover:-translate-y-px active:translate-y-0 flex-1 sm:flex-none"
          onclick="collapseAll()">Collapse All</button>
      </div>
      <span class="text-sm text-gray-400 whitespace-nowrap" id="teacherCount"></span>
    </div>

    <div id="loader" class="text-center mt-12 text-gray-500"><span class="spinner"></span>Loading Inventory...</div>
    <div id="app" class="flex flex-col gap-4 max-w-[900px] mx-auto" style="display:none;"></div>

    <!-- DEVICE EDIT MODAL -->
    <div id="modalOverlay" class="hidden fixed inset-0 bg-black/50 z-[100] justify-center items-center overscroll-contain">
      <div class="bg-white p-4 sm:p-6 rounded-lg w-[95%] sm:w-[90%] max-w-[480px] max-h-[85vh] sm:max-h-[90vh] overflow-y-auto shadow-xl scroll-touch">
        <h2 id="modalTitle" class="mt-0 mb-2 text-lg font-medium text-gray-800">Device Details</h2>
        <div id="modalDetails" class="mb-4 text-sm text-gray-500"></div>

        <form id="updateForm">
          <input type="hidden" id="rowIndex" name="rowIndex">
          <input type="hidden" id="replacementSerial" name="replacementSerial" value="">
          <input type="hidden" id="isCustomSerial" name="isCustomSerial" value="false">

          <label class="block mt-4 text-sm text-gray-500 font-medium">Status</label>
          <select id="statusSelect" name="status" onchange="toggleReplacement()"
            class="w-full p-2.5 mt-1 border border-gray-300 rounded box-border font-sans text-sm">
            <option value="Working">Working</option>
            <option value="Broken">Broken / Needs Repair</option>
          </select>

          <div id="replacementContainer" style="display:none;">
            <label class="block mt-4 text-sm text-gray-500 font-medium">Assign Replacement</label>

            <!-- Source toggle: Pool vs Custom -->
            <div class="flex mt-2 rounded-lg overflow-hidden border border-gray-300" id="serialSourceToggle">
              <button type="button" id="tabPool"
                class="flex-1 py-2.5 sm:py-2 px-3 text-sm font-medium cursor-pointer border-none transition-all duration-200 bg-primary text-white"
                onclick="switchSerialSource('pool')">
                From Pool
              </button>
              <button type="button" id="tabCustom"
                class="flex-1 py-2.5 sm:py-2 px-3 text-sm font-medium cursor-pointer border-none transition-all duration-200 bg-gray-50 text-gray-600 hover:bg-gray-100 hover:text-gray-800"
                onclick="switchSerialSource('custom')">
                Custom Serial
              </button>
            </div>

            <!-- Pool selection panel -->
            <div id="poolPanel">
              <div class="relative mt-2">
                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm pointer-events-none">&#128269;</span>
                <input
                  type="text"
                  id="poolSearch"
                  placeholder="Search by serial or model..."
                  oninput="filterPool()"
                  autocomplete="off"
                  class="w-full py-2.5 pl-9 pr-3.5 border border-gray-300 rounded-md font-sans text-sm box-border bg-gray-50 transition-all focus:outline-none focus:border-primary focus:bg-white m-0"
                >
              </div>

              <div class="flex gap-2 mt-1.5 items-center justify-between">
                <span class="text-xs text-gray-400" id="poolCount"></span>
                <select class="py-1.5 px-2 border border-gray-300 rounded text-xs bg-gray-50 cursor-pointer font-sans flex-shrink-0"
                  id="poolSort" onchange="filterPool()">
                  <option value="serial-asc">Serial A-Z</option>
                  <option value="serial-desc">Serial Z-A</option>
                  <option value="model-asc">Model A-Z</option>
                  <option value="model-desc">Model Z-A</option>
                </select>
              </div>

              <div class="mt-2 max-h-[220px] overflow-y-auto border border-gray-300 rounded-md bg-gray-50/50 scroll-touch" id="poolList"></div>
            </div>

            <!-- Custom serial input panel (hidden by default) -->
            <div id="customPanel" class="hidden">
              <div class="mt-3 p-4 bg-amber-50 border border-amber-200 rounded-lg">
                <p class="text-xs text-amber-700 mb-3 mt-0">Enter a serial number for a device not in the replacement pool. This serial will not be tracked in the pool inventory.</p>
                <label class="block text-sm text-gray-600 font-medium !mt-0 mb-1" for="customSerialInput">Serial Number</label>
                <input
                  type="text"
                  id="customSerialInput"
                  placeholder="Enter serial number..."
                  autocomplete="off"
                  oninput="onCustomSerialInput()"
                  class="w-full py-2.5 px-3 border border-gray-300 rounded-md font-mono text-sm box-border bg-white transition-all focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary/30"
                >
                <div id="customSerialValidation" class="text-xs mt-1.5 min-h-[1em]"></div>
              </div>
            </div>
          </div>

          <div class="flex flex-col-reverse sm:flex-row justify-end gap-2.5 mt-6">
            <button type="button" class="bg-gray-200 text-gray-700 px-5 py-3 sm:py-2.5 rounded cursor-pointer font-medium font-sans border-none hover:bg-gray-300 hover:shadow-sm hover:-translate-y-px active:translate-y-0 transition-all duration-200 w-full sm:w-auto" onclick="closeModal()">Cancel</button>
            <button type="button" class="btn-save-update bg-primary text-white px-5 py-3 sm:py-2.5 rounded cursor-pointer font-medium font-sans border-none hover:bg-blue-700 hover:shadow-md hover:-translate-y-0.5 active:translate-y-0 transition-all duration-200 w-full sm:w-auto" onclick="saveUpdate()">Save Update</button>
          </div>
        </form>
      </div>
    </div>

    <script>
      var globalData      = {};
      var globalPool      = [];
      var globalTeachers  = {};
      var selectedReplacement = '';
      var serialSource = 'pool';
      var mgmtPanelOpen = false;
      var auditPanelOpen = false;
      var auditLoaded = false;

      // ── TOAST NOTIFICATIONS ──
      function showToast(message, type) {
        var container = document.getElementById('toastContainer');
        var toast = document.createElement('div');

        var bgClass = 'bg-gray-700';
        var iconText = '';
        if (type === 'success') { bgClass = 'bg-good'; iconText = '\u2713 '; }
        if (type === 'error')   { bgClass = 'bg-broken'; iconText = '\u2717 '; }
        if (type === 'info')    { bgClass = 'bg-primary'; iconText = '\u2139 '; }

        toast.className = bgClass + ' text-white text-sm px-4 py-3 rounded-lg shadow-lg pointer-events-auto';
        toast.style.opacity = '0';
        toast.style.transform = 'translateX(20px)';
        toast.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
        toast.innerText = iconText + message;

        container.appendChild(toast);

        // Animate in
        setTimeout(function() {
          toast.style.opacity = '1';
          toast.style.transform = 'translateX(0)';
        }, 10);

        // Auto-dismiss
        var duration = type === 'error' ? 8000 : 5000;
        setTimeout(function() {
          toast.style.opacity = '0';
          toast.style.transform = 'translateX(20px)';
          setTimeout(function() {
            if (toast.parentNode) container.removeChild(toast);
          }, 300);
        }, duration);
      }

      // ── INITIAL LOAD ──
      window.onload = function() {
        google.script.run
          .withSuccessHandler(renderApp)
          .withFailureHandler(function(err) {
            var loader = document.getElementById('loader');
            loader.innerHTML = '<span class="text-broken font-medium">Failed to load inventory.</span><br><span class="text-gray-400 text-sm">Please refresh the page. ' + escHtml(err.message || '') + '</span>';
            showToast('Error loading data: ' + (err.message || err), 'error');
          })
          .getAppData();
      };

      // ── RENDER EVERYTHING ──
      function renderApp(data) {
        globalData     = data.inventory;
        globalPool     = data.replacements;
        globalTeachers = data.teacherRooms || {};

        renderTeacherTable();
        renderCards();
      }

      // ── TEACHER MANAGEMENT PANEL ──
      function toggleMgmtPanel() {
        mgmtPanelOpen = !mgmtPanelOpen;
        var body = document.getElementById('mgmtPanelBody');
        var icon = document.getElementById('mgmtCollapseIcon');
        var header = document.getElementById('mgmtPanelHeader');

        if (mgmtPanelOpen) {
          body.style.maxHeight = '800px';
          body.style.opacity = '1';
          body.style.paddingTop = '0';
          body.style.paddingBottom = '0';
          icon.style.transform = 'rotate(0deg)';
          header.classList.add('border-b', 'border-gray-200');
        } else {
          body.style.maxHeight = '0';
          body.style.opacity = '0';
          body.style.paddingTop = '0';
          body.style.paddingBottom = '0';
          icon.style.transform = 'rotate(-90deg)';
          header.classList.remove('border-b', 'border-gray-200');
        }
      }

      function renderTeacherTable() {
        var wrap = document.getElementById('teacherTableWrap');
        var keys = Object.keys(globalTeachers).sort();

        if (keys.length === 0) {
          wrap.innerHTML = '<p class="text-gray-400 text-sm text-center py-3">No teachers added yet. Use the form above to add one.</p>';
          return;
        }

        var html = '<table class="w-full border-collapse text-sm">' +
          '<thead><tr>' +
          '<th class="text-left py-2 px-2.5 border-b-2 border-gray-200 text-gray-500 font-medium">Teacher Name</th>' +
          '<th class="text-left py-2 px-2.5 border-b-2 border-gray-200 text-gray-500 font-medium">Room</th>' +
          '<th class="text-left py-2 px-2.5 border-b-2 border-gray-200 text-gray-500 font-medium"></th>' +
          '</tr></thead><tbody>';

        keys.forEach(function(name) {
          var room = globalTeachers[name] || '\u2014';
          html += '<tr class="hover:bg-gray-50 transition-colors">' +
            '<td class="py-2 px-2.5 border-b border-gray-100 text-gray-700">' + escHtml(name) + '</td>' +
            '<td class="py-2 px-2.5 border-b border-gray-100 text-gray-700">' + escHtml(room) + '</td>' +
            '<td class="py-2 px-2.5 border-b border-gray-100">' +
              '<button class="bg-transparent border border-gray-300 rounded px-2.5 py-1.5 sm:py-1 text-xs cursor-pointer text-primary font-sans hover:bg-primary-light hover:border-primary hover:shadow-sm hover:-translate-y-px active:translate-y-0 transition-all duration-200" onclick="prefillTeacher(' +
              JSON.stringify(name) + ',' + JSON.stringify(globalTeachers[name] || '') +
            ')">Edit</button></td>' +
            '</tr>';
        });

        html += '</tbody></table>';
        wrap.innerHTML = html;
      }

      function prefillTeacher(name, room) {
        document.getElementById('inputTeacherName').value = name;
        document.getElementById('inputRoomNumber').value  = room;
        document.getElementById('inputTeacherName').focus();
        setMgmtMsg('', '');
      }

      function saveTeacherEntry() {
        var name = document.getElementById('inputTeacherName').value.trim();
        var room = document.getElementById('inputRoomNumber').value.trim();

        if (!name) {
          setMgmtMsg('Teacher name is required.', 'error');
          return;
        }

        if (name.length > 100) {
          setMgmtMsg('Teacher name is too long (max 100 characters).', 'error');
          return;
        }

        var btn = document.getElementById('btnSaveTeacher');
        btn.disabled = true;
        btn.innerText = 'Saving...';
        setMgmtMsg('', '');

        google.script.run
          .withSuccessHandler(function(result) {
            btn.disabled = false;
            btn.innerText = 'Save Teacher';

            if (result.status === 'error') {
              setMgmtMsg(result.message, 'error');
              showToast(result.message, 'error');
              return;
            }

            globalTeachers[result.teacher] = result.room;
            renderTeacherTable();
            renderCards();

            document.getElementById('inputTeacherName').value = '';
            document.getElementById('inputRoomNumber').value  = '';

            var action = result.status === 'added' ? 'Added' : 'Updated';
            setMgmtMsg(action + ': ' + result.teacher + (result.room ? ' \u2014 Room ' + result.room : ''), 'success');
            showToast(action + ' teacher: ' + result.teacher, 'success');
          })
          .withFailureHandler(function(err) {
            btn.disabled = false;
            btn.innerText = 'Save Teacher';
            setMgmtMsg('Error: ' + err.message, 'error');
            showToast('Failed to save teacher: ' + (err.message || err), 'error');
          })
          .saveTeacher({ teacherName: name, roomNumber: room });
      }

      function setMgmtMsg(text, type) {
        var el = document.getElementById('mgmtMsg');
        el.innerText = text;
        el.className = 'text-sm py-1.5 min-h-[1.2em]';
        if (type === 'success') el.classList.add('text-good');
        if (type === 'error') el.classList.add('text-broken');
      }

      // ── AUDIT LOG PANEL ──
      function toggleAuditPanel() {
        auditPanelOpen = !auditPanelOpen;
        var body = document.getElementById('auditPanelBody');
        var icon = document.getElementById('auditCollapseIcon');
        var header = document.getElementById('auditPanelHeader');

        if (auditPanelOpen) {
          body.style.maxHeight = '800px';
          body.style.opacity = '1';
          icon.style.transform = 'rotate(0deg)';
          header.classList.add('border-b', 'border-gray-200');
          if (!auditLoaded) loadAuditLog();
        } else {
          body.style.maxHeight = '0';
          body.style.opacity = '0';
          icon.style.transform = 'rotate(-90deg)';
          header.classList.remove('border-b', 'border-gray-200');
        }
      }

      function loadAuditLog() {
        var wrap = document.getElementById('auditLogWrap');
        var btn = document.getElementById('btnRefreshAudit');
        wrap.innerHTML = '<div class="text-center py-4 text-gray-400"><span class="spinner"></span>Loading audit log...</div>';
        btn.disabled = true;
        btn.innerText = 'Loading...';

        google.script.run
          .withSuccessHandler(function(entries) {
            btn.disabled = false;
            btn.innerText = 'Refresh';
            auditLoaded = true;
            renderAuditLog(entries);
          })
          .withFailureHandler(function(err) {
            btn.disabled = false;
            btn.innerText = 'Refresh';
            wrap.innerHTML = '<div class="text-center py-4 text-broken">Failed to load audit log: ' + escHtml(err.message || err) + '</div>';
            showToast('Failed to load audit log.', 'error');
          })
          .getAuditLog(50);
      }

      function renderAuditLog(entries) {
        var wrap = document.getElementById('auditLogWrap');
        var countEl = document.getElementById('auditCount');

        if (!entries || entries.length === 0) {
          wrap.innerHTML = '<p class="text-gray-400 text-sm text-center py-3">No audit entries yet.</p>';
          countEl.innerText = '0 entries';
          return;
        }

        countEl.innerText = entries.length + ' recent entr' + (entries.length === 1 ? 'y' : 'ies');

        var html = '<div class="max-h-[400px] overflow-y-auto border border-gray-200 rounded-md scroll-touch">';
        html += '<table class="w-full border-collapse text-sm">';
        html += '<thead class="sticky top-0 bg-white"><tr>';
        html += '<th class="text-left py-2 px-2 sm:px-2.5 border-b-2 border-gray-200 text-gray-500 font-medium text-xs sm:text-sm">When</th>';
        html += '<th class="text-left py-2 px-2 sm:px-2.5 border-b-2 border-gray-200 text-gray-500 font-medium text-xs sm:text-sm">Who</th>';
        html += '<th class="text-left py-2 px-2 sm:px-2.5 border-b-2 border-gray-200 text-gray-500 font-medium text-xs sm:text-sm">Action</th>';
        html += '<th class="text-left py-2 px-2.5 border-b-2 border-gray-200 text-gray-500 font-medium hidden sm:table-cell">Target</th>';
        html += '<th class="text-left py-2 px-2.5 border-b-2 border-gray-200 text-gray-500 font-medium hidden md:table-cell">Details</th>';
        html += '</tr></thead><tbody>';

        entries.forEach(function(entry) {
          var ts = entry.timestamp ? new Date(entry.timestamp) : null;
          var timeStr = ts ? ts.toLocaleDateString() + ' ' + ts.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'}) : '\u2014';
          var userShort = (entry.user || '').split('@')[0];

          // Action badge color
          var actionClass = 'bg-gray-100 text-gray-600';
          if (entry.action && entry.action.indexOf('Update') !== -1) actionClass = 'bg-primary-light text-primary';
          if (entry.action && entry.action.indexOf('Added') !== -1) actionClass = 'bg-green-50 text-good';
          if (entry.action && entry.action.indexOf('Deleted') !== -1) actionClass = 'bg-broken-light text-broken';

          html += '<tr class="hover:bg-gray-50 transition-colors">';
          html += '<td class="py-2 px-2 sm:px-2.5 border-b border-gray-100 text-gray-500 whitespace-nowrap text-xs">' + escHtml(timeStr) + '</td>';
          html += '<td class="py-2 px-2 sm:px-2.5 border-b border-gray-100 text-gray-700 text-xs">' + escHtml(userShort) + '</td>';
          html += '<td class="py-2 px-2 sm:px-2.5 border-b border-gray-100"><span class="inline-block px-1.5 sm:px-2 py-0.5 rounded text-xs font-medium ' + actionClass + '">' + escHtml(entry.action || '') + '</span></td>';
          html += '<td class="py-2 px-2.5 border-b border-gray-100 text-gray-700 hidden sm:table-cell text-xs">' + escHtml(entry.target || '') + '</td>';
          html += '<td class="py-2 px-2.5 border-b border-gray-100 text-gray-500 hidden md:table-cell text-xs">' + escHtml(entry.details || '') + '</td>';
          html += '</tr>';
        });

        html += '</tbody></table></div>';
        wrap.innerHTML = html;
      }

      // ── TEACHER SEARCH ──
      function onTeacherSearch() {
        var query = document.getElementById('teacherSearch').value.toLowerCase().trim();
        var cards = document.querySelectorAll('.teacher-card');
        var shown = 0;
        var total = cards.length;

        cards.forEach(function(card) {
          var name = card.getAttribute('data-teacher').toLowerCase();
          var room = (card.getAttribute('data-room') || '').toLowerCase();
          if (!query || name.indexOf(query) !== -1 || room.indexOf(query) !== -1) {
            card.style.display = '';
            shown++;
          } else {
            card.style.display = 'none';
          }
        });

        var noResults = document.getElementById('noResults');
        if (shown === 0 && total > 0) {
          if (!noResults) {
            noResults = document.createElement('div');
            noResults.id = 'noResults';
            noResults.className = 'text-center text-gray-400 text-[0.95em] py-10 bg-card rounded-lg shadow-sm';
            document.getElementById('app').appendChild(noResults);
          }
          noResults.innerText = 'No teachers found matching "' + document.getElementById('teacherSearch').value.trim() + '"';
          noResults.style.display = '';
        } else if (noResults) {
          noResults.style.display = 'none';
        }

        updateTeacherCount(shown, total);
      }

      function updateTeacherCount(shown, total) {
        var el = document.getElementById('teacherCount');
        if (shown === total) {
          el.innerText = total + ' teacher' + (total !== 1 ? 's' : '');
        } else {
          el.innerText = shown + ' of ' + total + ' teacher' + (total !== 1 ? 's' : '');
        }
      }

      // ── COLLAPSE / EXPAND ALL ──
      function collapseAll() {
        document.querySelectorAll('.teacher-card').forEach(function(card) {
          collapseCard(card);
        });
      }

      function expandAll() {
        document.querySelectorAll('.teacher-card').forEach(function(card) {
          expandCard(card);
        });
      }

      function collapseCard(card) {
        card.classList.add('collapsed');
        var grid = card.querySelector('.slot-grid');
        var header = card.querySelector('.teacher-header');
        var icon = card.querySelector('.collapse-icon');
        if (grid) {
          grid.style.maxHeight = '0';
          grid.style.opacity = '0';
        }
        if (header) {
          header.classList.remove('border-b', 'border-gray-200');
          header.classList.add('mb-0', 'pb-0');
        }
        if (icon) icon.style.transform = 'rotate(-90deg)';
      }

      function expandCard(card) {
        card.classList.remove('collapsed');
        var grid = card.querySelector('.slot-grid');
        var header = card.querySelector('.teacher-header');
        var icon = card.querySelector('.collapse-icon');
        if (grid) {
          grid.style.maxHeight = '2000px';
          grid.style.opacity = '1';
        }
        if (header) {
          header.classList.add('border-b', 'border-gray-200');
          header.classList.remove('mb-0', 'pb-0');
        }
        if (icon) icon.style.transform = 'rotate(0deg)';
      }

      // ── RENDER TEACHER CARDS ──
      function renderCards() {
        var app = document.getElementById('app');
        app.innerHTML = '';

        var teachers = Object.keys(globalData).sort();

        teachers.forEach(function(teacher) {
          var card = document.createElement('div');
          card.className = 'teacher-card bg-card rounded-lg shadow-sm p-3 sm:p-4';
          card.setAttribute('data-teacher', teacher);
          var room = globalTeachers[teacher] || '';
          card.setAttribute('data-room', room);

          // --- Collapsible Header ---
          var header = document.createElement('div');
          header.className = 'teacher-header flex justify-between items-start border-b border-gray-200 mb-2 sm:mb-2.5 pb-2 cursor-pointer select-none';

          var info = document.createElement('div');
          info.className = 'flex-1';

          var nameEl = document.createElement('div');
          nameEl.className = 'font-medium text-[1.1em] text-gray-700 transition-colors';
          nameEl.innerText = teacher;
          info.appendChild(nameEl);

          if (room) {
            var roomEl = document.createElement('div');
            roomEl.className = 'text-xs text-gray-400 mt-0.5';
            roomEl.innerText = 'Room ' + room;
            info.appendChild(roomEl);
          }

          var devices = globalData[teacher];
          var brokenCount = devices.filter(function(d) { return d.status === 'Broken'; }).length;
          var statsEl = document.createElement('div');
          statsEl.className = 'text-xs text-gray-400 mt-1';
          var statsText = devices.length + ' device' + (devices.length !== 1 ? 's' : '');
          if (brokenCount > 0) {
            statsText += ' \u2022 <span class="text-broken font-medium">' + brokenCount + ' broken</span>';
          }
          statsEl.innerHTML = statsText;
          info.appendChild(statsEl);

          var icon = document.createElement('span');
          icon.className = 'collapse-icon text-xs text-gray-400 transition-transform duration-300 flex-shrink-0 ml-2 mt-1';
          icon.innerHTML = '&#9660;';

          header.appendChild(info);
          header.appendChild(icon);
          header.onclick = function() {
            if (card.classList.contains('collapsed')) {
              expandCard(card);
            } else {
              collapseCard(card);
            }
          };
          header.onmouseenter = function() { nameEl.classList.add('text-primary'); };
          header.onmouseleave = function() { nameEl.classList.remove('text-primary'); };

          card.appendChild(header);

          // --- Slot Grid ---
          var grid = document.createElement('div');
          grid.className = 'slot-grid grid grid-cols-[repeat(auto-fill,minmax(80px,1fr))] gap-2 overflow-hidden collapse-animate';
          grid.style.maxHeight = '2000px';
          grid.style.opacity = '1';

          var sortedDevices = devices.sort(function(a, b) {
            return parseInt(a.slot.replace('Slot ', '')) - parseInt(b.slot.replace('Slot ', ''));
          });

          sortedDevices.forEach(function(device) {
            var chip = document.createElement('div');
            var isBroken = device.status === 'Broken';
            chip.className = 'py-3 sm:py-2 px-1.5 sm:px-1 rounded text-center cursor-pointer text-sm select-none transition-transform active:scale-95 ' +
              (isBroken
                ? 'bg-broken-light text-broken border border-broken'
                : 'bg-primary-light text-primary');
            chip.innerHTML = '<span class="block font-bold text-xs opacity-70">' + escHtml(device.slot) + '</span>' + escHtml(device.serial.substring(0, 6)) + '...';
            chip.onclick = function() { openModal(device); };
            grid.appendChild(chip);
          });

          card.appendChild(grid);
          app.appendChild(card);
        });

        document.getElementById('loader').style.display = 'none';
        document.getElementById('toolbar').style.display = 'flex';
        app.style.display = 'flex';

        updateTeacherCount(teachers.length, teachers.length);
      }

      // ── SERIAL SOURCE TOGGLE ──
      function switchSerialSource(source) {
        serialSource = source;
        var tabPool = document.getElementById('tabPool');
        var tabCustom = document.getElementById('tabCustom');
        var poolPanel = document.getElementById('poolPanel');
        var customPanel = document.getElementById('customPanel');

        if (source === 'pool') {
          tabPool.className = 'flex-1 py-2.5 sm:py-2 px-3 text-sm font-medium cursor-pointer border-none transition-all duration-200 bg-primary text-white';
          tabCustom.className = 'flex-1 py-2.5 sm:py-2 px-3 text-sm font-medium cursor-pointer border-none transition-all duration-200 bg-gray-50 text-gray-600 hover:bg-gray-100 hover:text-gray-800';
          poolPanel.classList.remove('hidden');
          customPanel.classList.add('hidden');
          document.getElementById('customSerialInput').value = '';
          document.getElementById('customSerialValidation').innerText = '';
          document.getElementById('isCustomSerial').value = 'false';
          document.getElementById('replacementSerial').value = selectedReplacement;
        } else {
          tabCustom.className = 'flex-1 py-2.5 sm:py-2 px-3 text-sm font-medium cursor-pointer border-none transition-all duration-200 bg-primary text-white';
          tabPool.className = 'flex-1 py-2.5 sm:py-2 px-3 text-sm font-medium cursor-pointer border-none transition-all duration-200 bg-gray-50 text-gray-600 hover:bg-gray-100 hover:text-gray-800';
          customPanel.classList.remove('hidden');
          poolPanel.classList.add('hidden');
          document.getElementById('isCustomSerial').value = 'true';
          var customVal = document.getElementById('customSerialInput').value.trim();
          document.getElementById('replacementSerial').value = customVal;
        }
      }

      function onCustomSerialInput() {
        var val = document.getElementById('customSerialInput').value.trim();
        document.getElementById('replacementSerial').value = val;

        var validationEl = document.getElementById('customSerialValidation');

        if (!val) {
          validationEl.innerText = '';
          validationEl.className = 'text-xs mt-1.5 min-h-[1em]';
          return;
        }

        var inPool = globalPool.some(function(item) {
          return item.serial.toLowerCase() === val.toLowerCase();
        });

        if (inPool) {
          validationEl.innerText = 'This serial exists in the replacement pool. Consider using "From Pool" instead.';
          validationEl.className = 'text-xs mt-1.5 min-h-[1em] text-amber-600';
        } else if (val.length < 3) {
          validationEl.innerText = 'Serial number seems too short.';
          validationEl.className = 'text-xs mt-1.5 min-h-[1em] text-amber-600';
        } else {
          validationEl.innerText = 'Custom serial will be assigned.';
          validationEl.className = 'text-xs mt-1.5 min-h-[1em] text-good';
        }
      }

      // ── DEVICE MODAL ──
      function openModal(device) {
        document.getElementById('modalTitle').innerText = device.teacher + ' - ' + device.slot;
        document.getElementById('modalDetails').innerHTML =
          'Model: ' + escHtml(device.model) + '<br>Serial: <b>' + escHtml(device.serial) + '</b><br>Current Status: ' + escHtml(device.status);

        document.getElementById('rowIndex').value = device.rowIndex;
        document.getElementById('statusSelect').value = device.status || 'Working';

        // Reset all replacement controls
        document.getElementById('poolSearch').value = '';
        document.getElementById('poolSort').value = 'serial-asc';
        document.getElementById('customSerialInput').value = '';
        document.getElementById('customSerialValidation').innerText = '';
        document.getElementById('isCustomSerial').value = 'false';
        selectedReplacement = '';
        serialSource = 'pool';
        document.getElementById('replacementSerial').value = '';

        switchSerialSource('pool');
        filterPool();
        toggleReplacement();

        document.getElementById('modalOverlay').classList.remove('hidden');
        document.getElementById('modalOverlay').style.display = 'flex';
      }

      function filterPool() {
        var query  = document.getElementById('poolSearch').value.toLowerCase().trim();
        var sortBy = document.getElementById('poolSort').value;

        var filtered = globalPool.filter(function(item) {
          if (!query) return true;
          return item.serial.toLowerCase().indexOf(query) !== -1 ||
                 item.model.toLowerCase().indexOf(query) !== -1;
        });

        filtered.sort(function(a, b) {
          switch (sortBy) {
            case 'serial-asc':  return a.serial.localeCompare(b.serial);
            case 'serial-desc': return b.serial.localeCompare(a.serial);
            case 'model-asc':   return a.model.localeCompare(b.model);
            case 'model-desc':  return b.model.localeCompare(a.model);
            default:            return 0;
          }
        });

        var poolList = document.getElementById('poolList');
        poolList.innerHTML = '';

        if (filtered.length === 0) {
          poolList.innerHTML = '<div class="text-center text-gray-400 text-sm py-5">' +
            (query ? 'No devices matching "' + escHtml(query) + '"' : 'No available devices') +
            '</div>';
        } else {
          filtered.forEach(function(item) {
            var row = document.createElement('div');
            var isSelected = selectedReplacement === item.serial;
            row.className = 'flex items-center py-3 sm:py-2.5 px-3 cursor-pointer border-b border-gray-200 last:border-b-0 transition-colors gap-2.5 ' +
              (isSelected ? 'bg-primary-hover font-medium' : 'hover:bg-primary-light');
            row.setAttribute('data-serial', item.serial);

            var radio = document.createElement('div');
            radio.className = 'w-4 h-4 border-2 rounded-full flex-shrink-0 flex items-center justify-center transition-colors ' +
              (isSelected ? 'border-primary' : 'border-gray-300');
            if (isSelected) {
              var dot = document.createElement('div');
              dot.className = 'w-2 h-2 bg-primary rounded-full';
              radio.appendChild(dot);
            }

            var details = document.createElement('div');
            details.className = 'flex-1 min-w-0';
            var serialDiv = document.createElement('div');
            serialDiv.className = 'text-sm text-gray-700 font-mono break-all';
            serialDiv.textContent = item.serial;
            var modelDiv = document.createElement('div');
            modelDiv.className = 'text-xs text-gray-400 mt-px';
            modelDiv.textContent = item.model;
            details.appendChild(serialDiv);
            details.appendChild(modelDiv);

            row.appendChild(radio);
            row.appendChild(details);

            row.onclick = function() {
              if (selectedReplacement === item.serial) {
                selectedReplacement = '';
              } else {
                selectedReplacement = item.serial;
              }
              document.getElementById('replacementSerial').value = selectedReplacement;
              var items = poolList.querySelectorAll('[data-serial]');
              items.forEach(function(el) {
                var elSerial = el.getAttribute('data-serial');
                var elIsSelected = elSerial === selectedReplacement;
                el.className = 'flex items-center py-3 sm:py-2.5 px-3 cursor-pointer border-b border-gray-200 last:border-b-0 transition-colors gap-2.5 ' +
                  (elIsSelected ? 'bg-primary-hover font-medium' : 'hover:bg-primary-light');

                var radioEl = el.querySelector('div:first-child');
                radioEl.className = 'w-4 h-4 border-2 rounded-full flex-shrink-0 flex items-center justify-center transition-colors ' +
                  (elIsSelected ? 'border-primary' : 'border-gray-300');
                radioEl.innerHTML = elIsSelected ? '<div class="w-2 h-2 bg-primary rounded-full"></div>' : '';
              });
            };

            poolList.appendChild(row);
          });
        }

        var total = globalPool.length;
        var shown = filtered.length;
        document.getElementById('poolCount').innerText =
          shown === total
            ? total + ' device' + (total !== 1 ? 's' : '') + ' available'
            : shown + ' of ' + total + ' device' + (total !== 1 ? 's' : '') + ' shown';
      }

      function toggleReplacement() {
        var status    = document.getElementById('statusSelect').value;
        var container = document.getElementById('replacementContainer');
        if (status === 'Broken') {
          container.style.display = 'block';
        } else {
          container.style.display = 'none';
          selectedReplacement = '';
          document.getElementById('replacementSerial').value = '';
          document.getElementById('customSerialInput').value = '';
          document.getElementById('isCustomSerial').value = 'false';
        }
      }

      function closeModal() {
        document.getElementById('modalOverlay').style.display = 'none';
        document.getElementById('modalOverlay').classList.add('hidden');
      }

      function saveUpdate() {
        // Frontend validation
        var rowIndex = document.getElementById('rowIndex').value;
        if (!rowIndex || isNaN(parseInt(rowIndex, 10))) {
          showToast('Invalid device reference. Please close and reopen the modal.', 'error');
          return;
        }

        var status = document.getElementById('statusSelect').value;
        if (status === 'Broken' && serialSource === 'custom') {
          var customCheck = document.getElementById('customSerialInput').value.trim();
          if (customCheck && customCheck.length < 3) {
            showToast('Serial number is too short (minimum 3 characters).', 'error');
            return;
          }
        }

        var btn = document.querySelector('.btn-save-update');
        if (btn) {
          btn.innerText = 'Saving...';
          btn.disabled  = true;
        }

        // Ensure the hidden field has the right value based on current source
        if (serialSource === 'custom') {
          var customVal = document.getElementById('customSerialInput').value.trim();
          document.getElementById('replacementSerial').value = customVal;
          document.getElementById('isCustomSerial').value = 'true';
        } else {
          document.getElementById('isCustomSerial').value = 'false';
        }

        var form = document.getElementById('updateForm');

        google.script.run.withSuccessHandler(function() {
          closeModal();
          if (btn) {
            btn.innerText = 'Save Update';
            btn.disabled  = false;
          }
          showToast('Device updated successfully.', 'success');
          document.getElementById('loader').style.display = 'block';
          document.getElementById('loader').innerHTML = '<span class="spinner"></span>Refreshing...';
          document.getElementById('loader').className = 'text-center mt-12 text-gray-500';
          document.getElementById('app').style.display    = 'none';
          document.getElementById('toolbar').style.display = 'none';
          google.script.run
            .withSuccessHandler(renderApp)
            .withFailureHandler(function(err) {
              document.getElementById('loader').style.display = 'none';
              document.getElementById('app').style.display = 'flex';
              document.getElementById('toolbar').style.display = 'flex';
              showToast('Data saved but failed to refresh. Please reload the page.', 'error');
            })
            .getAppData();
        }).withFailureHandler(function(err) {
          if (btn) {
            btn.innerText = 'Save Update';
            btn.disabled  = false;
          }
          showToast('Error saving update: ' + (err.message || err), 'error');
        }).submitUpdate(form);
      }

      // ── UTILITY ──
      function escHtml(str) {
        return String(str)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;');
      }
    </script>
  </body>
</html>
