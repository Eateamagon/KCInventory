<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <?!= include('Styles'); ?>
</head>

<body class="bg-surface font-sans m-0 p-3 sm:p-5">

  <!-- TOAST NOTIFICATION CONTAINER -->
  <div id="toastContainer"
    class="fixed top-4 left-4 right-4 sm:left-auto sm:right-4 z-[200] flex flex-col gap-2 pointer-events-none sm:max-w-[380px]">
  </div>

  <!-- DARK MODE TOGGLE -->
  <div class="flex justify-end mb-3">
    <button id="darkModeToggle" onclick="toggleDarkMode()"
      class="bg-card border border-gray-300 rounded-lg px-3 py-2 text-sm cursor-pointer font-sans font-medium text-gray-600 shadow-sm hover:shadow-md hover:-translate-y-px active:translate-y-0 transition-all duration-200 flex items-center gap-2"
      title="Toggle dark mode">
      <span id="darkModeIcon" class="text-base leading-none">&#9789;</span>
      <span id="darkModeLabel">Dark Mode</span>
    </button>
  </div>

  <!-- CHROMECART MANAGEMENT PANEL -->
  <div id="mgmtPanel" class="bg-card rounded-lg shadow-sm mb-6 overflow-hidden">
    <div
      class="flex justify-between items-center px-3 sm:px-[18px] py-4 sm:py-3.5 cursor-pointer select-none border-b border-gray-200 font-medium text-gray-700 hover:text-primary-dark transition-colors"
      onclick="toggleMgmtPanel()" id="mgmtPanelHeader">
      <span>Chromecart Management</span>
      <span class="text-xs text-gray-400 transition-transform duration-300" id="mgmtCollapseIcon">&#9660;</span>
    </div>
    <div class="collapse-animate overflow-hidden max-h-0 opacity-0 px-3 sm:px-[18px] py-0" id="mgmtPanelBody">
      <div class="flex justify-between items-center pt-3 sm:pt-[18px] mb-3">
        <span class="text-sm text-gray-400" id="mgmtMsg"></span>
        <button
          class="bg-primary text-white px-4 py-2.5 sm:py-2 border-none rounded cursor-pointer font-medium font-sans text-sm whitespace-nowrap hover:bg-blue-700 hover:shadow-md hover:-translate-y-0.5 active:translate-y-0 transition-all duration-200"
          onclick="openCartModal(null)">+ Add Chromecart</button>
      </div>
      <div id="teacherTableWrap" class="pb-[18px] overflow-y-auto max-h-[60vh] scroll-touch"></div>
    </div>
  </div>

  <!-- AUDIT LOG FLOATING BUTTON -->
  <button id="auditFab"
    class="fixed bottom-4 right-4 z-50 bg-gray-600 text-white rounded-full w-11 h-11 shadow-lg flex items-center justify-center hover:bg-gray-700 hover:shadow-xl hover:-translate-y-0.5 transition-all duration-200 cursor-pointer border-none"
    onclick="toggleAuditModal()" title="Audit Log">
    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"
      stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round"
        d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
    </svg>
  </button>

  <!-- AUDIT LOG MODAL -->
  <div id="auditModal" class="hidden fixed inset-0 bg-black/50 z-[150] justify-center items-center overscroll-contain">
    <div
      class="bg-white rounded-lg w-[95%] sm:w-[90%] max-w-[640px] max-h-[80vh] overflow-hidden shadow-xl flex flex-col">
      <div class="flex justify-between items-center px-4 py-3 border-b border-gray-200 flex-shrink-0">
        <div class="flex items-center gap-3">
          <h3 class="text-lg font-medium text-gray-800 m-0">Audit Log</h3>
          <span class="text-sm text-gray-400" id="auditCount"></span>
        </div>
        <div class="flex items-center gap-2">
          <button
            class="bg-gray-50 border border-gray-300 rounded-md px-3 py-1.5 text-sm cursor-pointer font-sans font-medium text-gray-500 whitespace-nowrap transition-all duration-200 hover:bg-primary-light hover:text-primary-dark hover:border-primary hover:shadow-sm hover:-translate-y-px active:translate-y-0"
            onclick="loadAuditLog()" id="btnRefreshAudit">Refresh</button>
          <button onclick="closeAuditModal()"
            class="bg-transparent border-none text-gray-400 hover:text-gray-600 cursor-pointer text-xl leading-none p-1 transition-colors">&times;</button>
        </div>
      </div>
      <div class="overflow-y-auto flex-1 scroll-touch p-4" id="auditLogWrap">
        <p class="text-gray-400 text-sm text-center py-3">Loading audit entries...</p>
      </div>
    </div>
  </div>

  <!-- SEARCH & TOOLBAR -->
  <div
    class="bg-card rounded-lg shadow-sm mb-5 px-3 sm:px-[18px] py-3 sm:py-3.5 flex items-center gap-2 sm:gap-3 flex-wrap"
    id="toolbar" style="display:none;">
    <div class="w-full sm:flex-1 sm:min-w-[200px] relative">
      <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm pointer-events-none">&#128269;</span>
      <input type="text" id="teacherSearch" placeholder="Search for a chromecart..." oninput="onTeacherSearch()"
        autocomplete="off"
        class="w-full py-2.5 pl-9 pr-3.5 border border-gray-300 rounded-md font-sans text-[0.95em] box-border bg-gray-50 transition-all focus:outline-none focus:border-primary focus:bg-white">
    </div>
    <div class="flex gap-2 flex-shrink-0 w-full sm:w-auto">
      <button
        class="bg-gray-50 border border-gray-300 rounded-md px-3.5 py-2.5 sm:py-2 text-sm cursor-pointer font-sans font-medium text-gray-500 whitespace-nowrap transition-all duration-200 hover:bg-primary-light hover:text-primary-dark hover:border-primary hover:shadow-sm hover:-translate-y-px active:translate-y-0 flex-1 sm:flex-none"
        onclick="expandAll()">Expand All</button>
      <button
        class="bg-gray-50 border border-gray-300 rounded-md px-3.5 py-2.5 sm:py-2 text-sm cursor-pointer font-sans font-medium text-gray-500 whitespace-nowrap transition-all duration-200 hover:bg-primary-light hover:text-primary-dark hover:border-primary hover:shadow-sm hover:-translate-y-px active:translate-y-0 flex-1 sm:flex-none"
        onclick="collapseAll()">Collapse All</button>
    </div>
    <span class="text-sm text-gray-400 whitespace-nowrap" id="teacherCount"></span>
    <select id="layoutSelect" onchange="changeLayout()"
      class="py-1.5 px-2 border border-gray-300 rounded text-xs bg-gray-50 cursor-pointer font-sans flex-shrink-0 hidden sm:block">
      <option value="1">1 Column</option>
      <option value="2">2 Columns</option>
      <option value="3">3 Columns</option>
    </select>
  </div>

  <div id="loader" class="text-center mt-12 text-gray-500"><span class="spinner"></span>Loading Inventory...</div>
  <div id="app" class="flex flex-col gap-4 max-w-[900px] mx-auto" style="display:none;"></div>

  <!-- DEVICE EDIT MODAL -->
  <div id="modalOverlay"
    class="hidden fixed inset-0 bg-black/50 z-[100] justify-center items-center overscroll-contain">
    <div
      class="bg-white p-4 sm:p-6 rounded-lg w-[95%] sm:w-[90%] max-w-[480px] max-h-[85vh] sm:max-h-[90vh] overflow-y-auto shadow-xl scroll-touch">
      <h2 id="modalTitle" class="mt-0 mb-2 text-lg font-medium text-gray-800">Device Details</h2>
      <div id="modalDetails" class="mb-4 text-sm text-gray-500"></div>

      <form id="updateForm">
        <input type="hidden" id="rowIndex" name="rowIndex">
        <input type="hidden" id="replacementSerial" name="replacementSerial" value="">
        <input type="hidden" id="isCustomSerial" name="isCustomSerial" value="false">

        <label class="block mt-4 text-sm text-gray-500 font-medium">Status</label>
        <select id="statusSelect" name="status" onchange="toggleReplacement()"
          class="w-full p-2.5 mt-1 border border-gray-300 rounded box-border font-sans text-sm">
          <option value="Working">Working</option>
          <option value="Replace">Replace Device</option>
        </select>

        <div id="replacementContainer" style="display:none;">
          <label class="block mt-4 text-sm text-gray-500 font-medium">Assign Replacement</label>

          <!-- Source toggle: Pool vs Custom -->
          <div class="flex mt-2 rounded-lg overflow-hidden border border-gray-300" id="serialSourceToggle">
            <button type="button" id="tabPool"
              class="flex-1 py-2.5 sm:py-2 px-3 text-sm font-medium cursor-pointer border-none transition-all duration-200 bg-primary text-white"
              onclick="switchSerialSource('pool')">
              From Pool
            </button>
            <button type="button" id="tabCustom"
              class="flex-1 py-2.5 sm:py-2 px-3 text-sm font-medium cursor-pointer border-none transition-all duration-200 bg-gray-50 text-gray-600 hover:bg-gray-100 hover:text-gray-800"
              onclick="switchSerialSource('custom')">
              Custom Serial
            </button>
          </div>

          <!-- Pool selection panel -->
          <div id="poolPanel">
            <div class="relative mt-2">
              <span
                class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm pointer-events-none">&#128269;</span>
              <input type="text" id="poolSearch" placeholder="Search by serial or model..." oninput="filterPool()"
                autocomplete="off"
                class="w-full py-2.5 pl-9 pr-3.5 border border-gray-300 rounded-md font-sans text-sm box-border bg-gray-50 transition-all focus:outline-none focus:border-primary focus:bg-white m-0">
            </div>

            <div class="flex gap-2 mt-1.5 items-center justify-between">
              <span class="text-xs text-gray-400" id="poolCount"></span>
              <select
                class="py-1.5 px-2 border border-gray-300 rounded text-xs bg-gray-50 cursor-pointer font-sans flex-shrink-0"
                id="poolSort" onchange="filterPool()">
                <option value="serial-asc">Serial A-Z</option>
                <option value="serial-desc">Serial Z-A</option>
                <option value="model-asc">Model A-Z</option>
                <option value="model-desc">Model Z-A</option>
              </select>
            </div>

            <div class="mt-2 max-h-[220px] overflow-y-auto border border-gray-300 rounded-md bg-gray-50/50 scroll-touch"
              id="poolList"></div>
          </div>

          <!-- Custom serial input panel (hidden by default) -->
          <div id="customPanel" class="hidden">
            <div class="mt-3 p-4 bg-amber-50 border border-amber-200 rounded-lg">
              <p class="text-xs text-amber-700 mb-3 mt-0">Enter a serial number for a device not in the replacement
                pool. This serial will not be tracked in the pool inventory.</p>
              <label class="block text-sm text-gray-600 font-medium !mt-0 mb-1" for="customSerialInput">Serial
                Number</label>
              <input type="text" id="customSerialInput" placeholder="Enter serial number..." autocomplete="off"
                oninput="onCustomSerialInput()"
                class="w-full py-2.5 px-3 border border-gray-300 rounded-md font-mono text-sm box-border bg-white transition-all focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary/30">
              <div id="customSerialValidation" class="text-xs mt-1.5 min-h-[1em]"></div>
            </div>
          </div>
        </div>

        <div class="flex flex-col-reverse sm:flex-row justify-end gap-2.5 mt-6">
          <button type="button"
            class="bg-gray-200 text-gray-700 px-5 py-3 sm:py-2.5 rounded cursor-pointer font-medium font-sans border-none hover:bg-gray-300 hover:shadow-sm hover:-translate-y-px active:translate-y-0 transition-all duration-200 w-full sm:w-auto"
            onclick="closeModal()">Cancel</button>
          <button type="button"
            class="btn-save-update bg-primary text-white px-5 py-3 sm:py-2.5 rounded cursor-pointer font-medium font-sans border-none hover:bg-blue-700 hover:shadow-md hover:-translate-y-0.5 active:translate-y-0 transition-all duration-200 w-full sm:w-auto"
            onclick="saveUpdate()">Save Update</button>
        </div>
      </form>
    </div>
  </div>

  <!-- CHROMECART EDIT MODAL -->
  <div id="cartModalOverlay"
    class="hidden fixed inset-0 bg-black/50 z-[120] justify-center items-center overscroll-contain">
    <div
      class="bg-white rounded-lg w-[95%] sm:w-[90%] max-w-[600px] max-h-[90vh] overflow-hidden shadow-xl flex flex-col">
      <div class="flex justify-between items-center px-4 py-3 border-b border-gray-200 flex-shrink-0">
        <h2 id="cartModalTitle" class="text-lg font-medium text-gray-800 m-0">Add Chromecart</h2>
        <button onclick="closeCartModal()"
          class="bg-transparent border-none text-gray-400 hover:text-gray-600 cursor-pointer text-xl leading-none p-1 transition-colors">&times;</button>
      </div>
      <div class="overflow-y-auto flex-1 scroll-touch p-4">
        <div class="flex gap-2.5 flex-wrap mb-4">
          <div class="flex flex-col gap-1 w-20">
            <label class="text-sm text-gray-500 font-medium">Cart #</label>
            <input type="text" id="cartModalNumber" placeholder="#" autocomplete="off"
              class="px-2.5 py-2 border border-gray-300 rounded font-sans text-sm w-full box-border">
          </div>
          <div class="flex flex-col gap-1 flex-1 min-w-[140px]">
            <label class="text-sm text-gray-500 font-medium">Cart Name</label>
            <input type="text" id="cartModalName" placeholder="e.g. Smith" autocomplete="off"
              class="px-2.5 py-2 border border-gray-300 rounded font-sans text-sm w-full box-border">
          </div>
          <div class="flex flex-col gap-1 w-28">
            <label class="text-sm text-gray-500 font-medium">Room</label>
            <input type="text" id="cartModalRoom" placeholder="e.g. 204" autocomplete="off"
              class="px-2.5 py-2 border border-gray-300 rounded font-sans text-sm w-full box-border">
          </div>
        </div>

        <div id="cartDevicesSection">
          <div class="flex justify-between items-center mb-2">
            <span class="text-sm font-medium text-gray-700">Devices</span>
            <button type="button" onclick="addCartDevice()"
              class="bg-gray-50 border border-gray-300 rounded px-3 py-1 text-xs cursor-pointer font-sans font-medium text-gray-500 hover:bg-primary-light hover:text-primary-dark hover:border-primary transition-all duration-200">+
              Add Device</button>
          </div>
          <div id="cartDeviceList" class="border border-gray-200 rounded-md overflow-hidden"></div>
        </div>
      </div>
      <div
        class="flex flex-col-reverse sm:flex-row justify-between gap-2.5 px-4 py-3 border-t border-gray-200 flex-shrink-0">
        <button type="button" id="cartDeleteBtn"
          class="bg-broken/10 text-broken px-4 py-2.5 sm:py-2 rounded cursor-pointer font-medium font-sans text-sm border-none hover:bg-broken/20 transition-all duration-200 hidden"
          onclick="deleteCart()">Delete Chromecart</button>
        <div class="flex flex-col-reverse sm:flex-row gap-2.5">
          <button type="button"
            class="bg-gray-200 text-gray-700 px-5 py-2.5 sm:py-2 rounded cursor-pointer font-medium font-sans border-none hover:bg-gray-300 hover:shadow-sm hover:-translate-y-px active:translate-y-0 transition-all duration-200"
            onclick="closeCartModal()">Cancel</button>
          <button type="button" id="cartSaveBtn"
            class="bg-primary text-white px-5 py-2.5 sm:py-2 rounded cursor-pointer font-medium font-sans border-none hover:bg-blue-700 hover:shadow-md hover:-translate-y-0.5 active:translate-y-0 transition-all duration-200"
            onclick="saveCartModal()">Save</button>
        </div>
      </div>
    </div>
  </div>

  <?!= include('JavaScript'); ?>
</body>

</html>